{% extends "base.html" %}
{% load static %}
{% block title %}Турнир: {{ tournament.name }}{% endblock %}

{% block content %}
<style>
  .btn-row {
    display: flex;
    flex-wrap: wrap;
    justify-content: center; /* центрирование */
    gap: .5rem;
  }

  /* Универсальное правило для всех кнопок и форм */
  .btn-row > * {
    flex: 0 1 auto;
  }

  /* На мобильных делаем кнопки шириной ~80% экрана */
  @media (max-width: 576px) {
    .btn-row > * {
      flex: 0 1 80%;
      max-width: 320px;
      margin: 0 auto;
    }
  }
</style>

<div class="mb-3">
  <h2 class="mb-3 text-center">{{ tournament.name }}</h2>

  <div class="btn-row">
    {% if user.is_authenticated %}
      {% if user.player_profile and user.player_profile in participants %}
        <a class="btn btn-outline-dark" href="{% url 'tournaments:tournament_leave' tournament.pk %}">Покинуть</a>
      {% else %}
        <a class="btn btn-dark" href="{% url 'tournaments:tournament_join' tournament.pk %}">Присоединиться</a>
      {% endif %}
    {% endif %}

    {% if can_manage %}
      <!-- Форма генерации групп -->
      <form method="post" action="{% url 'tournaments:tournament_generate_groups_anytime' tournament.pk %}" class="d-flex flex-wrap justify-content-center gap-2">
        {% csrf_token %}
        <div class="d-flex align-items-center gap-2">
          <label class="form-label mb-0">Размер группы:</label>
          <select name="group_size" class="form-select form-select-sm" style="width:auto">
            <option value="3">3</option>
            <option value="4" selected>4</option>
            <option value="5">5</option>
          </select>
        </div>
        <button class="btn btn-outline-dark" type="submit">Сгенерировать группы</button>
      </form>

      <!-- Форма генерации плей-офф -->
      <form method="post" action="{% url 'tournaments:tournament_generate_knockout_any' tournament.pk %}" class="d-flex justify-content-center">
        {% csrf_token %}
        <button class="btn btn-dark" type="submit">Сгенерировать плей-офф</button>
      </form>

      <a class="btn btn-outline-secondary" href="{% url 'tournaments:tournament_edit' tournament.pk %}">Редактировать</a>
      <a class="btn btn-outline-danger" href="{% url 'tournaments:tournament_delete' tournament.pk %}">Удалить</a>
    {% endif %}
  </div>
</div>

<div class="card mb-3">
  <div class="card-body">
    <div class="row g-2">
      <div class="col-md-3"><strong>Дата:</strong> {{ tournament.date }}</div>
      <div class="col-md-3"><strong>Локация:</strong> {{ tournament.location }}</div>
      <div class="col-md-3"><strong>Формат:</strong> {{ tournament.format }}</div>
      <div class="col-md-3">
        <strong>Уровень:</strong>
        {% if tournament.min_level or tournament.max_level %}
          {{ tournament.min_level|default:"" }}{% if tournament.min_level and tournament.max_level %}–{% endif %}{{ tournament.max_level|default:"" }}
        {% else %}любой{% endif %}
      </div>
      {% if participants %}
        <div class="col-md-3"><strong>Участников:</strong> {{ participants.count }}</div>
      {% endif %}
    </div>
  </div>
</div>

{% if tournament.status == "GRP" %}
  <h4 class="mb-3">Группы</h4>
  {% for g in groups %}
    <div class="card mb-2">
      <div class="card-body d-flex justify-content-between align-items-center">
        <div>Группа {{ g.code }}</div>
        <a class="btn btn-sm btn-outline-dark" href="{% url 'tournaments:group_detail' g.pk %}">Открыть</a>
      </div>
    </div>
  {% empty %}
    <div class="alert alert-secondary">Группы ещё не созданы.</div>
  {% endfor %}

{% elif tournament.status == "KO" %}
  <h4 class="mb-3">Плей-офф</h4>
  {% if rounds %}
    {% for r, matches in rounds.items %}
      <div class="card mb-3">
        <div class="card-header">Раунд {{ r }}</div>
        <div class="list-group list-group-flush">
          {% for m in matches %}
            <div class="list-group-item">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  {{ m.p1|default:"—" }} vs {{ m.p2|default:"—" }}
                  {% if m.p1_score is not None and m.p2_score is not None %}
                    <span class="ms-2">Счёт: {{ m.p1_score }} : {{ m.p2_score }}</span>
                  {% endif %}
                </div>
                {% if can_manage %}
                  <form class="d-flex gap-2" method="post" action="{% url 'tournaments:bracket_set_score' m.pk %}">
                    {% csrf_token %}
                    <input type="number" name="p1_score" class="form-control form-control-sm" placeholder="P1" min="0" style="max-width:80px">
                    <input type="number" name="p2_score" class="form-control form-control-sm" placeholder="P2" min="0" style="max-width:80px">
                    <button class="btn btn-sm btn-dark">OK</button>
                  </form>
                {% endif %}
              </div>
            </div>
          {% endfor %}
        </div>
      </div>
    {% endfor %}
  {% else %}
    <div class="alert alert-secondary">Сетка плей-офф ещё не создана.</div>
  {% endif %}
{% else %}
  <div class="alert alert-secondary">Стадия ещё не сгенерирована.</div>
{% endif %}

{% if participants %}
  <div class="card mb-4">
    <div class="card-header">Участники ({{ participants.count }})</div>
    <div class="card-body">
      <div class="d-flex flex-wrap gap-2">
        {% for p in participants %}
          <a class="btn btn-outline-secondary btn-sm" href="{% url 'player_detail' p.pk %}">
            {{ p }}
          </a>
        {% endfor %}
      </div>
    </div>
  </div>
{% endif %}
{% endblock %}
