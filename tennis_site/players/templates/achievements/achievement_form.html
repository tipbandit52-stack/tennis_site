{% extends "base.html" %}
{% load static %}

{% block title %}
  {% if edit_mode %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ{% else %}–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ{% endif %}
{% endblock %}

{% block content %}
<div class="row justify-content-center fade-in">
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-body">
        <h3 class="card-title text-center mb-4">üèÜ {% if edit_mode %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å{% else %}–î–æ–±–∞–≤–∏—Ç—å{% endif %} –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ</h3>

        <form method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="mb-3">{{ form.title.label_tag }} {{ form.title }}</div>
          <div class="mb-3">{{ form.description.label_tag }} {{ form.description }}</div>

          <!-- –§–æ—Ç–æ -->
          <div class="mb-3">
            <label class="form-label">–§–æ—Ç–æ</label>
            {{ form.photo }}
            <input type="hidden" name="photo_data" id="photo_data">

            <div class="mt-3 text-center">
              <img id="crop-image" class="img-fluid rounded shadow-sm" style="max-width:100%; display:none; transition:0.3s ease;"/>
            </div>

            <div class="mt-3 d-flex flex-wrap justify-content-center gap-2">
              <button type="button" class="btn btn-warning" id="btn-crop" style="display:none;">‚úÇÔ∏è –û–±—Ä–µ–∑–∞—Ç—å (4:3)</button>
              <button type="button" class="btn btn-outline-secondary" id="btn-reset" style="display:none;">–°–±—Ä–æ—Å–∏—Ç—å</button>
            </div>

            <div id="crop-hint" class="form-text text-center" style="display:none;">–ü–æ—Å–ª–µ –æ–±—Ä–µ–∑–∫–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏—Ç–µ ‚Äú–°–æ—Ö—Ä–∞–Ω–∏—Ç—å‚Äù.</div>
          </div>

          <div class="text-center">
            <button class="btn btn-success px-4">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <a href="{% url 'player_detail' player.pk %}" class="btn btn-secondary px-4">–û—Ç–º–µ–Ω–∞</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- === CropperJS === -->
<link href="{% static 'css/cropper.min.css' %}" rel="stylesheet">
<script src="{% static 'js/cropper.min.js' %}"></script>
<script>
(function ensureCropper(cb){
  if (window.Cropper) return cb();
  // fallback –Ω–∞ CDN, –µ—Å–ª–∏ –ª–æ–∫–∞–ª—å–Ω—ã–π —Ñ–∞–π–ª –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è (404/–±–ª–æ–∫)
  var s = document.createElement('script');
  s.src = "https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js";
  s.onload = cb;
  document.head.appendChild(s);
})(function initCropper(){
  const input = document.getElementById("id_photo") || document.querySelector('input[type="file"][name="photo"]');
  const img = document.getElementById("crop-image");
  const btnCrop = document.getElementById("btn-crop");
  const btnReset = document.getElementById("btn-reset");
  const photoData = document.getElementById("photo_data");
  const hint = document.getElementById("crop-hint");
  let cropper = null;

  if (!input || !img) return;

  input.addEventListener("change", (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      img.src = reader.result;
      img.style.display = "block";
      hint && (hint.style.display = "block");
      btnCrop && (btnCrop.style.display = "inline-block");
      btnReset && (btnReset.style.display = "inline-block");
      if (cropper) cropper.destroy();
      cropper = new Cropper(img, {
        aspectRatio: 4 / 3,
        viewMode: 1,
        autoCropArea: 1,
        guides: true,     // —Å–µ—Ç–∫–∞
        center: true,     // —Ü–µ–Ω—Ç—Ä –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        highlight: true,  // –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –∫—Ä–∞—è
        background: true,
        responsive: true
      });
    };
    reader.readAsDataURL(file);
  });

  btnCrop && btnCrop.addEventListener("click", () => {
    if (!cropper) return;
    const canvas = cropper.getCroppedCanvas({ width: 1200, height: 900 });
    const dataUrl = canvas.toDataURL("image/jpeg", 0.92);
    photoData.value = dataUrl;           // base64 -> —É–π–¥—ë—Ç –≤ POST
    img.src = dataUrl;                   // –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä
    cropper.destroy(); cropper = null;   // –±–æ–ª—å—à–µ –Ω–µ –¥–≤–∏–≥–∞–µ–º —Ä–∞–º–∫—É
    btnCrop.style.display = "none";
  });

  btnReset && btnReset.addEventListener("click", () => {
    if (cropper) { cropper.destroy(); cropper = null; }
    img.style.display = "none";
    btnCrop && (btnCrop.style.display = "none");
    btnReset && (btnReset.style.display = "none");
    hint && (hint.style.display = "none");
    photoData.value = "";
    input.value = "";
  });
});
</script>
{% endblock %}