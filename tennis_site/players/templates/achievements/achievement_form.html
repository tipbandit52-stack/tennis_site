{% extends "base.html" %}
{% load static %}

{% block title %}
  {% if edit_mode %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ{% else %}–î–æ–±–∞–≤–∏—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ{% endif %}
{% endblock %}

{% block content %}
<div class="row justify-content-center fade-in">
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-body">
        <h3 class="card-title text-center mb-4">üèÜ {% if edit_mode %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å{% else %}–î–æ–±–∞–≤–∏—Ç—å{% endif %} –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–µ</h3>

        <form method="post" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="mb-3">{{ form.title.label_tag }} {{ form.title }}</div>
          <div class="mb-3">{{ form.description.label_tag }} {{ form.description }}</div>

          <!-- –§–æ—Ç–æ -->
          <div class="mb-3">
            <label class="form-label">–§–æ—Ç–æ</label>
            {{ form.photo }}
            <input type="hidden" name="photo_data" id="photo_data">

            <div class="mt-3 text-center">
              <img id="crop-image" class="img-fluid rounded shadow-sm" style="max-width:100%; display:none; transition:0.3s ease;"/>
            </div>

            <div class="mt-3 d-flex flex-wrap justify-content-center gap-2">
              <button type="button" class="btn btn-warning" id="btn-crop" style="display:none;">‚úÇÔ∏è –û–±—Ä–µ–∑–∞—Ç—å (4:3)</button>
              <button type="button" class="btn btn-outline-secondary" id="btn-reset" style="display:none;">–°–±—Ä–æ—Å–∏—Ç—å</button>
            </div>

            <div id="crop-hint" class="form-text text-center" style="display:none;">–ü–æ—Å–ª–µ –æ–±—Ä–µ–∑–∫–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏—Ç–µ ‚Äú–°–æ—Ö—Ä–∞–Ω–∏—Ç—å‚Äù.</div>
          </div>

          <div class="text-center">
            <button class="btn btn-success px-4">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <a href="{% url 'player_detail' player.pk %}" class="btn btn-secondary px-4">–û—Ç–º–µ–Ω–∞</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- === CropperJS === -->
<link href="{% static 'css/cropper.min.css' %}" rel="stylesheet">
<script src="{% static 'js/cropper.min.js' %}"></script>
<script>
(function() {
  const input = document.querySelector('input[type="file"][name="photo"]');
  const img = document.getElementById("crop-image");
  const btnCrop = document.getElementById("btn-crop");
  const btnReset = document.getElementById("btn-reset");
  const photoData = document.getElementById("photo_data");
  const hint = document.getElementById("crop-hint");
  let cropper = null;

  if (!input) return;

  input.addEventListener("change", (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = () => {
      img.src = reader.result;
      img.style.display = "block";
      hint.style.display = "block";
      btnCrop.style.display = "inline-block";
      btnReset.style.display = "inline-block";

      if (cropper) cropper.destroy();
      cropper = new Cropper(img, {
        aspectRatio: 4 / 3,
        viewMode: 1,
        autoCropArea: 1,
      });
    };
    reader.readAsDataURL(file);
  });

  btnCrop.addEventListener("click", () => {
    if (!cropper) return;
    const canvas = cropper.getCroppedCanvas({ width: 1200, height: 900 });
    const dataUrl = canvas.toDataURL("image/jpeg", 0.92);
    photoData.value = dataUrl;
    img.src = dataUrl;
    cropper.destroy();
    cropper = null;
    btnCrop.style.display = "none";
  });

  btnReset.addEventListener("click", () => {
    if (cropper) cropper.destroy();
    cropper = null;
    img.style.display = "none";
    btnCrop.style.display = "none";
    btnReset.style.display = "none";
    hint.style.display = "none";
    photoData.value = "";
    input.value = "";
  });
})();
</script>
{% endblock %}
