{% extends "base.html" %}
{% load static %}

{% block title %}{% if edit_mode %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è{% else %}–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å{% endif %}{% endblock %}

{% block content %}
<div class="row justify-content-center">
  <div class="col-lg-8">
    <div class="card shadow-sm">
      <div class="card-body">
        <h3 class="card-title text-center mb-4">
          {% if edit_mode %}üë§ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è{% else %}üë§ –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å{% endif %}
        </h3>

        <form method="post" enctype="multipart/form-data">
          {% csrf_token %}

          <div class="row g-3">
            <div class="col-md-6">
              {{ form.first_name.label_tag }} {{ form.first_name }}
            </div>
            <div class="col-md-6">
              {{ form.last_name.label_tag }} {{ form.last_name }}
            </div>
            <div class="col-md-4">
              {{ form.age.label_tag }} {{ form.age }}
            </div>
            <div class="col-md-4">
              {{ form.level.label_tag }} {{ form.level }}
            </div>
            <div class="col-md-4">
              {{ form.phone_number.label_tag }} {{ form.phone_number }}
            </div>
            <div class="col-12">
              {{ form.address.label_tag }} {{ form.address }}
            </div>

            <!-- –§–æ—Ç–æ -->
            <div class="col-12">
              <label class="form-label">–§–æ—Ç–æ</label>
              {{ form.photo }}
              <input type="hidden" name="photo_data" id="photo_data">
              <div class="mt-3">
                <img id="crop-image" style="max-width:100%; display:none;"/>
              </div>
              <div class="mt-2 d-flex gap-2">
                <button type="button" class="btn btn-warning" id="btn-crop" style="display:none;">‚úÇÔ∏è –û–±—Ä–µ–∑–∞—Ç—å (4:3)</button>
                <button type="button" class="btn btn-outline-secondary" id="btn-reset" style="display:none;">–°–±—Ä–æ—Å–∏—Ç—å</button>
              </div>
              <div id="crop-hint" class="form-text" style="display:none;">–ü–æ—Å–ª–µ –æ–±—Ä–µ–∑–∫–∏ –ø—Ä–æ—Å—Ç–æ –Ω–∞–∂–º–∏—Ç–µ ‚Äú–°–æ—Ö—Ä–∞–Ω–∏—Ç—å‚Äù.</div>
            </div>
          </div>

          <div class="text-center mt-4">
            <button class="btn btn-success px-4">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <a class="btn btn-secondary px-4" href="{% url 'players_list' %}">–û—Ç–º–µ–Ω–∞</a>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.2/cropper.min.js"></script>
<script>
(function () {
  const input = document.getElementById("id_photo");
  const img = document.getElementById("crop-image");
  const btnCrop = document.getElementById("btn-crop");
  const btnReset = document.getElementById("btn-reset");
  const photoData = document.getElementById("photo_data");
  const hint = document.getElementById("crop-hint");
  let cropper = null;

  if (!input) return;

  input.addEventListener("change", (e) => {
    const file = e.target.files && e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = () => {
      img.src = reader.result;
      img.style.display = "block";
      hint.style.display = "block";
      btnCrop.style.display = "inline-block";
      btnReset.style.display = "inline-block";
      if (cropper) { cropper.destroy(); }
      cropper = new Cropper(img, {
        aspectRatio: 4 / 3,
        viewMode: 1,
        autoCropArea: 1,
      });
    };
    reader.readAsDataURL(file);
  });

  btnCrop.addEventListener("click", () => {
    if (!cropper) return;
    const canvas = cropper.getCroppedCanvas({ width: 1200, height: 900 });
    const dataUrl = canvas.toDataURL("image/jpeg", 0.92);
    photoData.value = dataUrl; // —Å–µ—Ä–≤–µ—Ä —Å–∞–º —Å–æ–∑–¥–∞—Å—Ç —É–Ω–∏–∫–∞–ª—å–Ω–æ–µ –∏–º—è
    img.src = dataUrl;
  });

  btnReset.addEventListener("click", () => {
    if (cropper) { cropper.destroy(); cropper = null; }
    img.style.display = "none";
    btnCrop.style.display = "none";
    btnReset.style.display = "none";
    hint.style.display = "none";
    photoData.value = "";
    input.value = "";
  });
})();
</script>
{% endblock %}
