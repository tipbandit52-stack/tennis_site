{% extends "base.html" %}
{% block title %}–î—Ä—É–∑—å—è{% endblock %}

{% block content %}
<h2 class="mb-4">üë• –î—Ä—É–∑—å—è</h2>

<ul class="nav nav-tabs mb-4" role="tablist">
  <li class="nav-item" role="presentation">
    <a class="nav-link {% if active_tab == 'friends' %}active{% endif %}"
       href="?tab=friends" role="tab">–ú–æ–∏ –¥—Ä—É–∑—å—è
      <span class="badge bg-secondary ms-2">{{ friends|length }}</span>
    </a>
  </li>
  <li class="nav-item" role="presentation">
    <a class="nav-link {% if active_tab == 'incoming' %}active{% endif %}"
       href="?tab=incoming" role="tab">–í—Ö–æ–¥—è—â–∏–µ
      <span class="badge bg-secondary ms-2">{{ incoming_requests|length }}</span>
    </a>
  </li>
  <li class="nav-item" role="presentation">
    <a class="nav-link {% if active_tab == 'outgoing' %}active{% endif %}"
       href="?tab=outgoing" role="tab">–ò—Å—Ö–æ–¥—è—â–∏–µ
      <span class="badge bg-secondary ms-2">{{ outgoing_requests|length }}</span>
    </a>
  </li>
</ul>

{# ---------- –°–ø–∏—Å–æ–∫: –ú–æ–∏ –¥—Ä—É–∑—å—è ---------- #}
{% if active_tab == 'friends' %}
  {% if friends %}
    <div class="list-group">
      {% for item in friends %}
        {% with p=item.player %}
        <div class="list-group-item d-flex align-items-center justify-content-between py-3 chat-row">
          <div class="d-flex align-items-center gap-3">
            {% if p.photo %}
              <img src="{{ p.photo.url }}" alt="" class="rounded-circle" style="width:48px;height:48px;object-fit:cover;">
            {% else %}
              <img src="https://via.placeholder.com/48?text=U" alt="" class="rounded-circle" style="width:48px;height:48px;object-fit:cover;">
            {% endif %}
            <div>
              <div class="fw-semibold">{{ p.first_name }} {{ p.last_name }}</div>
              {% if p.address %}<div class="text-muted small">{{ p.address }}</div>{% endif %}
            </div>
          </div>
          <div class="friend-actions">
            <a href="{% url 'player_detail' p.pk %}" class="btn btn-dark btn-sm">–ü—Ä–æ—Ñ–∏–ª—å</a>
            <a href="{% url 'chat:chat_with' p.pk %}" class="btn btn-outline-dark btn-sm">–°–æ–æ–±—â–µ–Ω–∏–µ</a>
            <form method="post" action="{% url 'remove_friend' item.friendship_pk %}?tab=friends" class="d-inline">
              {% csrf_token %}
              <button class="btn btn-outline-danger btn-sm">–£–¥–∞–ª–∏—Ç—å</button>
            </form>
          </div>
        </div>
        {% endwith %}
      {% endfor %}
    </div>
  {% else %}
    <div class="text-muted">–ü–æ–∫–∞ –Ω–µ—Ç –¥—Ä—É–∑–µ–π.</div>
  {% endif %}
{% endif %}

{# ---------- –°–ø–∏—Å–æ–∫: –í—Ö–æ–¥—è—â–∏–µ ---------- #}
{% if active_tab == 'incoming' %}
  {% if incoming_requests %}
    <div class="list-group">
      {% for item in incoming_requests %}
        {% with p=item.player %}
        <div class="list-group-item d-flex align-items-center justify-content-between py-3 chat-row">
          <div class="d-flex align-items-center gap-3">
            {% if p.photo %}
              <img src="{{ p.photo.url }}" alt="" class="rounded-circle" style="width:48px;height:48px;object-fit:cover;">
            {% else %}
              <img src="https://via.placeholder.com/48?text=U" alt="" class="rounded-circle" style="width:48px;height:48px;object-fit:cover;">
            {% endif %}
            <div>
              <div class="fw-semibold">{{ p.first_name }} {{ p.last_name }}</div>
              {% if p.address %}<div class="text-muted small">{{ p.address }}</div>{% endif %}
            </div>
          </div>
          <div class="friend-actions">
            <a href="{% url 'player_detail' p.pk %}" class="btn btn-dark btn-sm">–ü—Ä–æ—Ñ–∏–ª—å</a>
            <a href="{% url 'chat:chat_with' p.pk %}" class="btn btn-outline-dark btn-sm">–°–æ–æ–±—â–µ–Ω–∏–µ</a>
            <form method="post" action="{% url 'accept_friend' item.friendship_pk %}?tab=incoming" class="d-inline">
              {% csrf_token %}
              <button class="btn btn-success btn-sm">–ü—Ä–∏–Ω—è—Ç—å</button>
            </form>
            <form method="post" action="{% url 'reject_friend' item.friendship_pk %}?tab=incoming" class="d-inline">
              {% csrf_token %}
              <button class="btn btn-outline-danger btn-sm">–û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            </form>
          </div>
        </div>
        {% endwith %}
      {% endfor %}
    </div>
  {% else %}
    <div class="text-muted">–ù–µ—Ç –≤—Ö–æ–¥—è—â–∏—Ö –∑–∞—è–≤–æ–∫.</div>
  {% endif %}
{% endif %}

{# ---------- –°–ø–∏—Å–æ–∫: –ò—Å—Ö–æ–¥—è—â–∏–µ ---------- #}
{% if active_tab == 'outgoing' %}
  {% if outgoing_requests %}
    <div class="list-group">
      {% for item in outgoing_requests %}
        {% with p=item.player %}
        <div class="list-group-item d-flex align-items-center justify-content-between py-3 chat-row">
          <div class="d-flex align-items-center gap-3">
            {% if p.photo %}
              <img src="{{ p.photo.url }}" alt="" class="rounded-circle" style="width:48px;height:48px;object-fit:cover;">
            {% else %}
              <img src="https://via.placeholder.com/48?text=U" alt="" class="rounded-circle" style="width:48px;height:48px;object-fit:cover;">
            {% endif %}
            <div>
              <div class="fw-semibold">{{ p.first_name }} {{ p.last_name }}</div>
              {% if p.address %}<div class="text-muted small">{{ p.address }}</div>{% endif %}
            </div>
          </div>
          <div class="friend-actions">
            <a href="{% url 'player_detail' p.pk %}" class="btn btn-dark btn-sm">–ü—Ä–æ—Ñ–∏–ª—å</a>
            <a href="{% url 'chat:chat_with' p.pk %}" class="btn btn-outline-dark btn-sm">–°–æ–æ–±—â–µ–Ω–∏–µ</a>
            <form method="post" action="{% url 'cancel_request' item.friendship_pk %}?tab=outgoing" class="d-inline">
              {% csrf_token %}
              <button class="btn btn-outline-warning btn-sm">–û—Ç–º–µ–Ω–∏—Ç—å</button>
            </form>
          </div>
        </div>
        {% endwith %}
      {% endfor %}
    </div>
  {% else %}
    <div class="text-muted">–ù–µ—Ç –∏—Å—Ö–æ–¥—è—â–∏—Ö –∑–∞—è–≤–æ–∫.</div>
  {% endif %}
{% endif %}

{% endblock %}
